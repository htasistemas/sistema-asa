<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unidades - ASA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' },
                            primary: { 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet & SheetJS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/menu.css">

    <style>
        /* Estilos inline de backup caso o CSS externo falhe */
        body { font-family: 'Roboto', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tooltip-container { position: relative; }
        .tooltip-text {
            visibility: hidden; width: max-content; max-width: 250px; background-color: #7f1d1d; color: #fff;
            text-align: center; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 50; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .group:hover .group-hover\:block { display: block; animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CORE LÓGICA (Injetado para evitar erro de CORS local) ---
        
        const loadState = (key, fallback) => {
            try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
        };

        const formatTitleCase = (str) => {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => {
                if (word.toUpperCase() === 'ASA') return 'ASA';
                if (/^(da|de|do|das|dos|e)$/.test(word)) return word;
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        };

        const preLoadedUnits = [
            { id: 1, name: 'ASA Alto Umuarama', city: 'Uberlândia', director: 'Carmem Lamounier', phone: '(34) 99166-3300', neighborhood: 'Alto Umuarama', address: 'Rua Paulo Frontin', number: '1321', zipcode: '', email: '', state: 'MG', region: 'Leste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 2, name: 'ASA Bela Vista', city: 'Canápolis', director: 'Maria Aparecida da Silva Tavares - Nina', phone: '(34) 99722-4833', neighborhood: 'Bela Vista', address: 'Rua 8', number: '1098', zipcode: '38.380-000', email: 'nina.sita@hotmail.com', state: 'MG', region: '', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 3, name: 'ASA Boa Vista', city: 'Araxá', director: 'Monica Maria Silva Santiago', phone: '(34) 99932-3490', neighborhood: 'Boa Vista', address: 'Rua Augusto Alves', number: '306', zipcode: '', email: '', state: 'MG', region: '', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 4, name: 'ASA Buritis', city: 'Uberlândia', director: 'Maria Amelia Pereira da Silva', phone: '(34) 99287-1002', neighborhood: 'Buritis', address: 'Rua Petronilha Rodrigues de Queiroz', number: '110', zipcode: '', email: '', state: 'MG', region: 'Sul', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 5, name: 'ASA Canaã', city: 'Uberlândia', director: 'Maria Aparecida Odilon Bezerra', phone: '(34) 99922-2246', neighborhood: 'Canaã', address: 'Av. Babel', number: '653', zipcode: '', email: '', state: 'MG', region: 'Oeste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 24, name: 'ASA Morada Nova', city: 'Uberlândia', director: 'Lucielena Balbina de Jesus', phone: '(34) 99699-9707', neighborhood: 'Morada Nova', address: 'Rua Benedita da Silva Santos', number: '153', zipcode: '', email: '', state: 'MG', region: 'Oeste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 25, name: 'ASA Morumbi', city: 'Uberlândia', director: 'Lucas Cipriano Mendes', phone: '(34) 99835-9449', neighborhood: 'Morumbi', address: 'Rua Taperas', number: '339', zipcode: '', email: '', state: 'MG', region: 'Leste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 38, name: 'ASA Nova Serrana', city: 'Nova Serrana', director: 'Ana Lucia Barbosa de Matos', phone: '(37) 99142-2552', neighborhood: 'Romeu Duarte', address: 'Rua Divino Ferreira', number: '736', zipcode: '35.519-000', email: '', state: 'MG', region: '', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 26, name: 'ASA Panorama', city: 'Uberlândia', director: '', phone: '', neighborhood: 'Panorama', address: 'Rua das Espatódias', number: '858', zipcode: '', email: '', state: 'MG', region: 'Oeste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 28, name: 'ASA Pequis', city: 'Uberlândia', director: 'Yedros Modesto Rezende', phone: '(34) 99892-2018', neighborhood: 'Pequis', address: 'Av. Wilson Rodrigues da Silva', number: '630 LJ 6', zipcode: '', email: 'sosmanutencoesuberlandia@gmail.com', state: 'MG', region: 'Oeste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 29, name: 'ASA Roosevelt', city: 'Uberlândia', director: 'Maria Regina Cardoso', phone: '(34) 99239-9352', neighborhood: 'Roosevelt', address: 'Rua Virgilio Mineiro', number: '25', zipcode: '', email: '', state: 'MG', region: 'Norte', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] },
            { id: 30, name: 'ASA Santa Mônica', city: 'Uberlândia', director: 'Ana', phone: '(34) 9999-9999', neighborhood: 'Santa Mônica', address: 'Av. Segismundo Pereira', number: '1200', zipcode: '', email: '', state: 'MG', region: 'Leste', electionYear: 2024, lastUpdated: new Date().toISOString().split('T')[0] }
        ];

        // Componentes de Ícones
        const Icons = {
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            FileText: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            AlertTriangle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            CheckCircle2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Pencil: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Sun: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 0 1 1-9-9Z"/></svg>,
            ChevronDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            LogOut: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            MapPin: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Clock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        // --- Componentes Compartilhados ---
        const Header = ({ activePage }) => {
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('asa_theme') === 'dark');

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('asa_theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('asa_theme', 'light');
                }
            }, [darkMode]);

            const handleLogout = () => {
                sessionStorage.removeItem('asa_auth');
                window.location.reload();
            };

            return (
                <header className="bg-white dark:bg-gray-800 border-b border-green-600 dark:border-green-900 sticky top-0 z-50 no-print shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.location.href='dashboard.html'}>
                            <img src="../img/asa.jpg" alt="ASA" className="h-10 w-auto rounded object-contain" onError={(e)=>{e.target.onerror=null;e.target.src="https://via.placeholder.com/40?text=ASA"}}/>
                            <div><h1 className="text-xl font-bold dark:text-white text-green-800">Monitoramento ASA</h1></div>
                        </div>
                        <nav className="hidden md:flex gap-6 items-center">
                            <a href="dashboard.html" className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${activePage === 'dashboard' ? 'text-green-600 dark:text-green-400 bg-green-50 dark:bg-gray-700' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Dashboard</a>
                            
                            <div className="relative group">
                                <button className={`flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${['units','unit_life','structure','mgmt'].includes(activePage) ? 'text-green-600' : 'text-gray-600 dark:text-gray-300'}`}>
                                    Gestão de Unidades <Icons.ChevronDown size={14}/>
                                </button>
                                <div className="dropdown-menu bg-white dark:bg-gray-800 hidden group-hover:block border border-gray-100 dark:border-gray-700 absolute left-0 mt-0 w-48 rounded-lg shadow-lg z-50">
                                    <a href="unidades.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Lista de Unidades</a>
                                    <a href="vidaunidade.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Vida da Unidade</a>
                                    <a href="estrutura.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Estrutura & ID</a>
                                    <a href="gestaointerna.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Gestão Interna</a>
                                </div>
                            </div>

                            <div className="relative group">
                                <button className={`flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${['distribution','files','map'].includes(activePage) ? 'text-green-600' : 'text-gray-600 dark:text-gray-300'}`}>
                                    Operacional <Icons.ChevronDown size={14}/>
                                </button>
                                <div className="dropdown-menu bg-white dark:bg-gray-800 hidden group-hover:block border border-gray-100 dark:border-gray-700 absolute left-0 mt-0 w-48 rounded-lg shadow-lg z-50">
                                    <a href="distribuicao.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Distribuição</a>
                                    <a href="arquivos.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Arquivos</a>
                                    <a href="mapa.html" className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-gray-700">Mapa Geral</a>
                                </div>
                            </div>
                        </nav>
                        <div className="flex gap-2">
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">{darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}</button>
                            <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 p-2"><Icons.LogOut size={18}/></button>
                        </div>
                    </div>
                </header>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [u, setU] = useState(''); const [p, setP] = useState(''); const [e, setE] = useState('');
            const handleSubmit = (ev) => { ev.preventDefault(); if(u === 'adm' && p === 'adm') onLogin(); else setE('Inválido'); };
            return (<div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900 bg-gradient-to-br from-green-500/20 to-blue-500/20"><div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl flex overflow-hidden border border-gray-200 dark:border-gray-700"><div className="hidden md:block w-1/2 bg-cover bg-center relative" style={{backgroundImage: "url('https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80')"}}><div className="absolute inset-0 bg-green-900/40 flex flex-col justify-end p-8 text-white"><h3 className="text-2xl font-bold mb-2">Unidos para Servir</h3></div></div><div className="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center"><div className="flex justify-center mb-6"><img src="../img/asa.jpg" alt="Logo ASA" className="h-24 w-auto object-contain" onError={(e) => {e.target.onerror = null; e.target.src="https://via.placeholder.com/150x80?text=ASA+Logo"}} /></div><div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-800 dark:text-white">Acesso Restrito</h2></div><form onSubmit={handleSubmit} className="space-y-5"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Usuário</label><input type="text" value={u} onChange={(ev)=>setU(ev.target.value)} className="w-full px-4 py-3 border rounded-lg outline-none bg-white dark:bg-gray-700 dark:text-white"/></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Senha</label><input type="password" value={p} onChange={(ev)=>setP(ev.target.value)} className="w-full px-4 py-3 border rounded-lg outline-none bg-white dark:bg-gray-700 dark:text-white"/></div>{e && <p className="text-red-500 text-sm text-center">{e}</p>}<button type="submit" className="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-3 rounded-lg hover:from-green-700 hover:to-green-800">Entrar</button></form></div></div></div>);
        };
        
        // --- MAPA MODAL (para formulário) ---
        const ModalMap = ({ unit }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            
            useEffect(() => {
                if (unit && unit.lat && unit.lng) {
                     if (!mapInstanceRef.current && mapRef.current) {
                        const map = L.map(mapRef.current).setView([unit.lat, unit.lng], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM contributors' }).addTo(map);
                        mapInstanceRef.current = map;
                         L.marker([unit.lat, unit.lng]).addTo(map);
                    } else if(mapInstanceRef.current) {
                        mapInstanceRef.current.setView([unit.lat, unit.lng], 15);
                        // Limpa marcadores antigos se houver (simplificado)
                        mapInstanceRef.current.eachLayer((layer) => {
                            if (layer instanceof L.Marker) { mapInstanceRef.current.removeLayer(layer); }
                        });
                        L.marker([unit.lat, unit.lng]).addTo(mapInstanceRef.current);
                        mapInstanceRef.current.invalidateSize();
                    }
                }
            }, [unit]);
            
            return <div ref={mapRef} className="modal-map-container bg-gray-100"></div>;
        };


        // --- PÁGINA: UNIDADES ---
        function UnitsPage() {
            const [isAuthenticated, setIsAuthenticated] = useState(() => sessionStorage.getItem('asa_auth') === 'true');
            const [units, setUnits] = useState(() => loadState('asa_units_v10_final', preLoadedUnits));
            const [unitSearch, setUnitSearch] = useState('');
            const [showUnitForm, setShowUnitForm] = useState(false);
            const [isGeocoding, setIsGeocoding] = useState(false);

            // Form State
            const defaultUnit = { id: null, name: '', director: '', phone: '', email: '', zipcode: '', address: '', number: '', neighborhood: '', city: 'Uberlândia', state: 'MG', region: '', lat: null, lng: null, electionYear: new Date().getFullYear(), lastUpdated: new Date().toISOString().split('T')[0] };
            const [newUnit, setNewUnit] = useState(defaultUnit);

            useEffect(() => localStorage.setItem('asa_units_v10_final', JSON.stringify(units)), [units]);

            if (!isAuthenticated) return <LoginScreen onLogin={() => { sessionStorage.setItem('asa_auth', 'true'); setIsAuthenticated(true); }} />;

            const filteredUnits = units.filter(u => u.name.toLowerCase().includes(unitSearch.toLowerCase()) || (u.city && u.city.toLowerCase().includes(unitSearch.toLowerCase())));
            
            const isOutdated = (d) => { if(!d) return true; const dt = new Date(d+'T12:00:00'); const six = new Date(); six.setMonth(six.getMonth()-6); return dt < six; };
            const getPendingFields = (u) => { const m=[]; if(!u.director)m.push('Diretor'); if(!u.phone)m.push('Tel'); if(!u.email)m.push('Email'); if(!u.zipcode)m.push('CEP'); if(!u.address)m.push('Endereço'); if(!u.neighborhood)m.push('Bairro'); return m; };

            const handleSaveUnit = (e) => {
                e.preventDefault();
                const exists = units.some(u => u.name.toLowerCase().trim() === newUnit.name.toLowerCase().trim() && u.id !== newUnit.id);
                if(exists) return alert("Já existe uma unidade com este nome!");
                
                const uSave = {...newUnit, lastUpdated: new Date().toISOString().split('T')[0]}; 
                if(newUnit.id) setUnits(units.map(u=>u.id===newUnit.id?uSave:u)); 
                else setUnits([...units, {...uSave, id:Date.now()}]); 
                setShowUnitForm(false);
            };

            const handleEditUnit = (u) => { setNewUnit(u); setShowUnitForm(true); };
            const handleDeleteUnit = (id) => { if(confirm("Excluir?")) setUnits(units.filter(u=>u.id!==id)); };
            const handleCapitalize = (e, f) => setNewUnit({...newUnit, [f]: formatTitleCase(e.target.value)});
            const handlePhoneMask = (e) => { let v=e.target.value.replace(/\D/g,'').slice(0,11); if(v.length>6)v=`(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`; else if(v.length>2)v=`(${v.slice(0,2)}) ${v.slice(2)}`; setNewUnit({...newUnit, phone:v}); };
            const handleCepMask = (e) => { let v=e.target.value.replace(/\D/g,'').slice(0,8); if(v.length>5)v=`${v.slice(0,5)}-${v.slice(5)}`; setNewUnit({...newUnit, zipcode:v}); };
            
            const handleGeocode = async () => {
                if (!newUnit.address || !newUnit.city) return alert("Preencha Endereço e Cidade.");
                setIsGeocoding(true);
                try {
                    const q = `${newUnit.address}, ${newUnit.number}, ${newUnit.neighborhood}, ${newUnit.city}, ${newUnit.state}, Brazil`;
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                    const d = await r.json();
                    if (d.length > 0) {
                        setNewUnit(prev => ({ ...prev, lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon) }));
                    } else alert("Não encontrado.");
                } catch (e) { alert("Erro conexão."); } finally { setIsGeocoding(false); }
            };

            const handleCepBlur = async (e) => { 
                const c=e.target.value.replace(/\D/g,''); 
                if(c.length===8){ 
                    try{ 
                        const r=await fetch(`https://viacep.com.br/ws/${c}/json/`); 
                        const d=await r.json(); 
                        if(!d.erro) setNewUnit(p=>({...p, address:formatTitleCase(d.logradouro), neighborhood:formatTitleCase(d.bairro), city:formatTitleCase(d.localidade), state:d.uf})); 
                    }catch(e){} 
                } 
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <Header activePage="units" />
                    <main className="flex-1 w-full mx-auto px-4 py-8 max-w-7xl animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold dark:text-white">Gerenciar Unidades</h2>
                            <div className="flex gap-2">
                                <div className="relative">
                                    <input type="text" placeholder="Buscar..." className="pl-8 pr-4 py-2 border rounded-lg text-sm outline-none dark:bg-gray-700 dark:text-white" value={unitSearch} onChange={e=>setUnitSearch(e.target.value)}/>
                                    <Icons.Search className="absolute left-2 top-2.5 text-gray-400" size={16} />
                                </div>
                                <label className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm cursor-pointer"><Icons.Upload size={16}/> Excel <input type="file" className="hidden" /></label>
                                <button onClick={() => { setNewUnit(defaultUnit); setShowUnitForm(true); }} className="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm"><Icons.Plus size={16}/> Nova</button>
                            </div>
                        </div>
                        
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <table className="w-full text-sm text-left text-gray-600 dark:text-gray-300">
                                <thead className="bg-gray-50 dark:bg-gray-750 text-xs uppercase"><tr><th className="px-6 py-3">Nome</th><th className="px-6 py-3">Diretor</th><th className="px-6 py-3">Mandato</th><th className="px-6 py-3">Pendências</th><th className="px-6 py-3 text-right">Ações</th></tr></thead>
                                <tbody>
                                    {filteredUnits.length === 0 ? <tr><td colSpan="5" className="px-6 py-8 text-center">Nenhum registro.</td></tr> : filteredUnits.map(u => {
                                        const pending = getPendingFields(u);
                                        return (
                                            <tr key={u.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 border-b dark:border-gray-700">
                                                <td className="px-6 py-4 font-medium dark:text-white">{u.name}<div className="text-[10px] text-gray-400 mt-1">Atualizado: {u.lastUpdated ? new Date(u.lastUpdated+'T12:00:00').toLocaleDateString() : '-'}</div></td>
                                                <td className="px-6 py-4">{u.director}</td>
                                                <td className="px-6 py-4"><span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-bold ${u.electionYear == 2026 ? 'bg-green-100 text-green-800' : u.electionYear == 2025 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}`}>{u.electionYear}</span></td>
                                                <td className="px-6 py-4">{pending.length > 0 ? <div className="tooltip-container text-red-500 cursor-help"><Icons.AlertTriangle size={16} /><span className="tooltip-text">Falta: {pending.join(', ')}</span></div> : <span className="text-green-500 text-xs font-bold flex items-center gap-1"><Icons.CheckCircle2 size={12}/> OK</span>}</td>
                                                <td className="px-6 py-4 text-right"><button onClick={() => handleEditUnit(u)} className="text-blue-500 mr-2"><Icons.Pencil size={18}/></button><button onClick={() => handleDeleteUnit(u.id)} className="text-red-500"><Icons.Trash2 size={18}/></button></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </main>

                    {/* MODAL DE CADASTRO */}
                    {showUnitForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-gray-800 w-full max-w-lg rounded-xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <h3 className="font-bold mb-4 dark:text-white text-lg">Cadastro de Unidade</h3>
                                <form onSubmit={handleSaveUnit} className="space-y-4">
                                    <input required className="w-full border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Nome da Unidade" value={newUnit.name} onChange={e=>handleCapitalize(e, 'name')} />
                                    <input className="w-full border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Nome do Diretor" value={newUnit.director} onChange={e=>handleCapitalize(e, 'director')} />
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="text" className="border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Telefone" value={newUnit.phone} onChange={handlePhoneMask}/>
                                        <input type="email" className="border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="E-mail" value={newUnit.email} onChange={e => setNewUnit({...newUnit, email: e.target.value})}/>
                                    </div>

                                    <div className="flex gap-2">
                                        <input type="text" className="w-1/3 border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="CEP" value={newUnit.zipcode} onChange={handleCepMask} onBlur={handleCepBlur} />
                                        <button type="button" onClick={handleGeocode} className="bg-blue-100 text-blue-700 px-3 py-2 rounded text-xs flex items-center gap-1 hover:bg-blue-200"><Icons.MapPin size={14}/> Buscar GPS</button>
                                    </div>

                                    <div className="grid grid-cols-4 gap-2">
                                        <input type="text" className="col-span-3 border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Endereço" value={newUnit.address} onChange={(e) => handleCapitalize(e, 'address')} />
                                        <input type="text" className="col-span-1 border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Nº" value={newUnit.number} onChange={(e) => setNewUnit({...newUnit, number: e.target.value})} />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="text" className="border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Bairro" value={newUnit.neighborhood} onChange={(e) => handleCapitalize(e, 'neighborhood')} />
                                        <input type="text" className="border p-2 rounded dark:bg-gray-700 dark:text-white" placeholder="Cidade" value={newUnit.city} onChange={(e) => handleCapitalize(e, 'city')} />
                                    </div>

                                    <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded flex items-center gap-4">
                                        <label className="text-sm dark:text-white">Ano de Eleição:</label>
                                        <input type="number" className="w-20 border p-1 rounded dark:bg-gray-600 dark:text-white" value={newUnit.electionYear} onChange={(e) => setNewUnit({...newUnit, electionYear: e.target.value})} />
                                    </div>

                                    {/* MAPA VISUAL NO MODAL */}
                                    {newUnit.lat && newUnit.lng && (
                                        <div className="border rounded overflow-hidden shadow-sm">
                                            <div className="bg-green-100 text-green-800 text-xs p-1 text-center font-bold">Localização Encontrada: {newUnit.lat}, {newUnit.lng}</div>
                                            <ModalMap unit={newUnit} />
                                        </div>
                                    )}

                                    <div className="flex justify-end gap-2 pt-2">
                                        <button type="button" onClick={()=>setShowUnitForm(false)} className="px-4 py-2 text-gray-500 hover:text-gray-700">Cancelar</button>
                                        <button className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">Salvar Unidade</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UnitsPage />);
    </script>
</body>
</html>