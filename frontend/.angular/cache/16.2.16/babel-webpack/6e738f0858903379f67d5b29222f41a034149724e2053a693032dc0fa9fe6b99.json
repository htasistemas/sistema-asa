{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { AppDialogComponent } from '../shared/app-dialog.component';\nexport let UnitsPageComponent = class UnitsPageComponent {\n  constructor(unidadeService, rota) {\n    this.unidadeService = unidadeService;\n    this.rota = rota;\n    this.dataImpressao = new Date();\n    this.unidades = [];\n    this.unidadesFiltradas = [];\n    this.filtroAtivo = '';\n    this.novaUnidade = {\n      nomeUnidade: '',\n      diretor: '',\n      telefone: '',\n      bairro: '',\n      cidade: '',\n      regiao: '',\n      distrito: '',\n      emailUnidade: '',\n      enderecoCompleto: '',\n      anoEleicao: undefined\n    };\n    this.unidadeSelecionada = null;\n    this.mensagemErro = '';\n    this.exibirErro = false;\n    this.mostrarFormulario = false;\n    this.mostrarFiltroBusca = false;\n    this.termoBusca = '';\n    this.filtroBusca = 'geral';\n    this.dialogoExclusaoAberto = false;\n    this.unidadeParaExcluir = null;\n    this.opcoesBusca = [{\n      valor: 'geral',\n      rotulo: 'Geral'\n    }, {\n      valor: 'unidade',\n      rotulo: 'Unidade'\n    }, {\n      valor: 'bairro',\n      rotulo: 'Bairro'\n    }, {\n      valor: 'cidade',\n      rotulo: 'Cidade'\n    }, {\n      valor: 'regiao',\n      rotulo: 'Região'\n    }, {\n      valor: 'distrito',\n      rotulo: 'Distrito'\n    }, {\n      valor: 'status',\n      rotulo: 'Status'\n    }, {\n      valor: 'anoEleicao',\n      rotulo: 'Ano Eleição'\n    }];\n    this.regioes = ['Triângulo Norte', 'Triângulo Sul', 'Alto Paranaíba', 'Centro Oeste', 'Sudoeste'];\n  }\n  ngOnInit() {\n    this.carregar();\n    this.rota.queryParamMap.subscribe(params => {\n      const id = params.get('id');\n      const filtro = params.get('filtro');\n      this.filtroAtivo = filtro || '';\n      this.aplicarFiltro();\n      if (!id) {\n        return;\n      }\n      const idNumerico = Number(id);\n      if (Number.isNaN(idNumerico)) {\n        return;\n      }\n      this.unidadeService.buscarPorId(idNumerico).subscribe({\n        next: unidade => {\n          this.unidadeSelecionada = unidade;\n          this.novaUnidade = {\n            ...unidade\n          };\n          this.mostrarFormulario = true;\n        },\n        error: () => this.mostrarErro('Nao foi possivel carregar a unidade selecionada.')\n      });\n    });\n  }\n  carregar() {\n    this.unidadeService.listar().subscribe({\n      next: unidades => {\n        this.unidades = unidades;\n        this.aplicarFiltro();\n        this.aplicarBusca();\n      },\n      error: () => this.mostrarErro('Nao foi possivel buscar as unidades cadastradas.')\n    });\n  }\n  iniciarNovaUnidade() {\n    this.novaUnidade = {\n      nomeUnidade: '',\n      diretor: '',\n      telefone: '',\n      bairro: '',\n      cidade: '',\n      regiao: '',\n      distrito: '',\n      emailUnidade: '',\n      enderecoCompleto: '',\n      anoEleicao: undefined\n    };\n    this.unidadeSelecionada = null;\n    this.mostrarFormulario = true;\n  }\n  salvarUnidade() {\n    this.formatarNomeUnidade();\n    this.formatarDiretor();\n    this.aplicarMascaraTelefone();\n    if (!this.validarEmailUnidade()) {\n      return;\n    }\n    if (!this.validarCamposObrigatorios()) {\n      this.mostrarErro('Preencha todos os campos obrigatorios antes de salvar.');\n      return;\n    }\n    const payload = {\n      ...this.novaUnidade,\n      id: this.unidadeSelecionada?.id\n    };\n    const requisicao = payload.id ? this.unidadeService.atualizar(payload) : this.unidadeService.criar(payload);\n    requisicao.subscribe({\n      next: () => {\n        this.iniciarNovaUnidade();\n        this.carregar();\n        this.mostrarFormulario = false;\n      },\n      error: () => this.mostrarErro('Nao foi possivel salvar a unidade. Tente novamente.')\n    });\n  }\n  excluirUnidade(id) {\n    this.unidadeService.excluir(id).subscribe({\n      next: () => this.carregar(),\n      error: () => this.mostrarErro('Nao foi possivel excluir a unidade.')\n    });\n  }\n  confirmarExclusao(unidade) {\n    if (!unidade.id) {\n      return;\n    }\n    this.unidadeParaExcluir = unidade;\n    this.dialogoExclusaoAberto = true;\n  }\n  cancelarExclusao() {\n    this.dialogoExclusaoAberto = false;\n    this.unidadeParaExcluir = null;\n  }\n  confirmarExclusaoDialogo() {\n    if (!this.unidadeParaExcluir?.id) {\n      this.cancelarExclusao();\n      return;\n    }\n    this.excluirUnidade(this.unidadeParaExcluir.id);\n    this.cancelarExclusao();\n  }\n  selecionarUnidade(unidade) {\n    this.unidadeSelecionada = unidade;\n    this.novaUnidade = {\n      ...unidade\n    };\n  }\n  editarUnidadeSelecionada() {\n    if (!this.unidadeSelecionada) {\n      this.mostrarErro('Selecione uma unidade para editar.');\n      return;\n    }\n    this.novaUnidade = {\n      ...this.unidadeSelecionada\n    };\n    this.mostrarFormulario = true;\n  }\n  editarUnidadeDireto(unidade) {\n    this.unidadeSelecionada = unidade;\n    this.novaUnidade = {\n      ...unidade\n    };\n    this.mostrarFormulario = true;\n  }\n  excluirUnidadeSelecionada() {\n    if (!this.unidadeSelecionada?.id) {\n      this.mostrarErro('Selecione uma unidade para excluir.');\n      return;\n    }\n    if (!window.confirm('Confirma a exclusao da unidade selecionada?')) {\n      return;\n    }\n    this.excluirUnidade(this.unidadeSelecionada.id);\n    this.unidadeSelecionada = null;\n  }\n  imprimirCadastro() {\n    window.print();\n  }\n  validarCamposObrigatorios() {\n    return !!(this.novaUnidade.nomeUnidade && this.novaUnidade.diretor && this.novaUnidade.cidade && this.novaUnidade.anoEleicao);\n  }\n  anoEleicaoInvalido() {\n    return !!this.novaUnidade.anoEleicao && this.novaUnidade.anoEleicao < 2026;\n  }\n  obterStatusUnidade(unidade) {\n    if (this.unidadeDesatualizada(unidade)) {\n      return 'DESATUALIZADO';\n    }\n    const incompleto = this.unidadeIncompleta(unidade);\n    if (incompleto) {\n      return 'INCOMPLETO';\n    }\n    if (unidade.anoEleicao && unidade.anoEleicao < 2026) {\n      return 'BLOQUEADO';\n    }\n    return 'ATIVO';\n  }\n  unidadeIncompleta(unidade) {\n    return !unidade.nomeUnidade || !unidade.diretor || !unidade.telefone || !unidade.bairro || !unidade.cidade || !unidade.emailUnidade || !unidade.enderecoCompleto || !unidade.anoEleicao;\n  }\n  unidadeDesatualizada(unidade) {\n    const dataBaseTexto = unidade.dataAtualizacao || unidade.dataCriacao;\n    if (!dataBaseTexto) {\n      return true;\n    }\n    const dataBase = new Date(dataBaseTexto);\n    if (Number.isNaN(dataBase.getTime())) {\n      return true;\n    }\n    const hoje = new Date();\n    const limite = new Date(hoje.getFullYear(), hoje.getMonth() - 3, hoje.getDate());\n    return dataBase < limite;\n  }\n  aoDigitarNomeUnidade(evento) {\n    const input = evento.target;\n    if (!input) {\n      return;\n    }\n    const valorFormatado = this.obterNomeUnidadeFormatado(input.value);\n    this.aplicarValorFormatado(input, valorFormatado);\n    this.novaUnidade.nomeUnidade = valorFormatado;\n  }\n  aoDigitarDiretor(evento) {\n    const input = evento.target;\n    if (!input) {\n      return;\n    }\n    const valorFormatado = this.formatarTituloPreservandoEspacos(input.value);\n    this.aplicarValorFormatado(input, valorFormatado);\n    this.novaUnidade.diretor = valorFormatado;\n  }\n  aoDigitarTextoTitulo(evento, campo) {\n    const elemento = evento.target;\n    if (!elemento) {\n      return;\n    }\n    const valorFormatado = this.formatarTituloPreservandoEspacos(elemento.value);\n    this.aplicarValorFormatado(elemento, valorFormatado);\n    this.novaUnidade[campo] = valorFormatado;\n  }\n  formatarNomeUnidade() {\n    const valorFormatado = this.obterNomeUnidadeFormatado(this.novaUnidade.nomeUnidade || '');\n    this.novaUnidade.nomeUnidade = valorFormatado;\n  }\n  formatarDiretor() {\n    const valorFormatado = this.formatarTituloPreservandoEspacos(this.novaUnidade.diretor || '');\n    this.novaUnidade.diretor = valorFormatado;\n  }\n  aplicarMascaraTelefone() {\n    const valor = this.novaUnidade.telefone || '';\n    const digitos = valor.replace(/\\D/g, '').slice(0, 11);\n    if (!digitos) {\n      this.novaUnidade.telefone = '';\n      return;\n    }\n    const ddd = digitos.slice(0, 2);\n    const parteUm = digitos.length > 10 ? digitos.slice(2, 7) : digitos.slice(2, 6);\n    const parteDois = digitos.length > 10 ? digitos.slice(7, 11) : digitos.slice(6, 10);\n    const numeroFormatado = parteDois ? `(${ddd}) ${parteUm}-${parteDois}` : `(${ddd}) ${parteUm}`;\n    this.novaUnidade.telefone = numeroFormatado;\n  }\n  validarEmailUnidade() {\n    const email = this.novaUnidade.emailUnidade?.trim();\n    if (!email) {\n      return true;\n    }\n    const regexEmail = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!regexEmail.test(email)) {\n      this.mostrarErro('Informe um e-mail valido para a unidade.');\n      return false;\n    }\n    return true;\n  }\n  obterNomeUnidadeFormatado(valor) {\n    const valorSemEspacoInicial = valor.replace(/^\\s+/, '');\n    if (!valorSemEspacoInicial) {\n      return 'ASA';\n    }\n    const valorSemPrefixo = valorSemEspacoInicial.toUpperCase().startsWith('ASA') ? valorSemEspacoInicial.slice(3) : valorSemEspacoInicial;\n    const nomeFormatado = this.formatarTituloPreservandoEspacos(valorSemPrefixo);\n    const nomeSemEspacoInicial = nomeFormatado.replace(/^\\s+/, '');\n    return nomeSemEspacoInicial ? `ASA ${nomeSemEspacoInicial}` : 'ASA';\n  }\n  aplicarValorFormatado(elemento, valorFormatado) {\n    if (elemento.value === valorFormatado) {\n      return;\n    }\n    const posicaoCursor = elemento.selectionStart ?? elemento.value.length;\n    const distanciaFim = elemento.value.length - posicaoCursor;\n    elemento.value = valorFormatado;\n    const novaPosicao = Math.max(valorFormatado.length - distanciaFim, 0);\n    elemento.setSelectionRange(novaPosicao, novaPosicao);\n  }\n  formatarTituloPreservandoEspacos(valor) {\n    return valor.split(/(\\s+)/).map(parte => {\n      if (/^\\s+$/.test(parte)) {\n        return parte;\n      }\n      const texto = parte.toLowerCase();\n      return texto.charAt(0).toUpperCase() + texto.slice(1);\n    }).join('');\n  }\n  abrirLocalizacao() {\n    const partesEndereco = [this.novaUnidade.enderecoCompleto, this.novaUnidade.bairro, this.novaUnidade.cidade].filter(Boolean);\n    if (partesEndereco.length === 0) {\n      this.mostrarErro('Informe o endereco antes de abrir o mapa.');\n      return;\n    }\n    const endereco = encodeURIComponent(partesEndereco.join(', '));\n    window.open(`https://www.google.com/maps/search/?api=1&query=${endereco}`, '_blank');\n  }\n  mostrarErro(mensagem) {\n    this.mensagemErro = mensagem;\n    this.exibirErro = true;\n  }\n  fecharErro() {\n    this.exibirErro = false;\n  }\n  fecharFormulario() {\n    this.mostrarFormulario = false;\n  }\n  aplicarFiltro() {\n    if (!this.filtroAtivo) {\n      this.unidadesFiltradas = [...this.unidades];\n      return;\n    }\n    if (this.filtroAtivo === 'pendencias') {\n      this.unidadesFiltradas = this.unidades.filter(unidade => !unidade.telefone || !unidade.emailUnidade || !unidade.bairro || !unidade.enderecoCompleto);\n      return;\n    }\n    if (this.filtroAtivo === 'desatualizadas') {\n      this.unidadesFiltradas = this.unidades.filter(unidade => !unidade.enderecoCompleto || !unidade.emailUnidade);\n      return;\n    }\n    this.unidadesFiltradas = [...this.unidades];\n  }\n  alternarFiltroBusca() {\n    this.mostrarFiltroBusca = !this.mostrarFiltroBusca;\n  }\n  aplicarBusca() {\n    const termoNormalizado = this.normalizarTexto(this.termoBusca);\n    if (!termoNormalizado) {\n      return;\n    }\n    this.unidadesFiltradas = this.unidadesFiltradas.filter(unidade => {\n      switch (this.filtroBusca) {\n        case 'unidade':\n          return this.normalizarTexto(unidade.nomeUnidade).includes(termoNormalizado);\n        case 'bairro':\n          return this.normalizarTexto(unidade.bairro).includes(termoNormalizado);\n        case 'cidade':\n          return this.normalizarTexto(unidade.cidade).includes(termoNormalizado);\n        case 'regiao':\n          return this.normalizarTexto(unidade.regiao).includes(termoNormalizado);\n        case 'distrito':\n          return this.normalizarTexto(unidade.distrito).includes(termoNormalizado);\n        case 'status':\n          return this.normalizarTexto(this.obterStatusUnidade(unidade)).includes(termoNormalizado);\n        case 'anoEleicao':\n          return String(unidade.anoEleicao || '').includes(termoNormalizado);\n        default:\n          return this.normalizarTexto([unidade.nomeUnidade, unidade.diretor, unidade.telefone, unidade.bairro, unidade.cidade, unidade.regiao, unidade.distrito, unidade.emailUnidade].filter(Boolean).join(' ')).includes(termoNormalizado);\n      }\n    });\n  }\n  limparBusca() {\n    this.termoBusca = '';\n    this.filtroBusca = 'geral';\n    this.aplicarFiltro();\n  }\n  normalizarTexto(valor) {\n    return (valor || '').normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toLowerCase().trim();\n  }\n};\nUnitsPageComponent = __decorate([Component({\n  selector: 'app-units-page',\n  standalone: true,\n  imports: [CommonModule, FormsModule, AppDialogComponent],\n  templateUrl: './units-page.component.html',\n  styleUrls: ['./units-page.component.css']\n})], UnitsPageComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}